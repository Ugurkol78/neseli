<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Satıcı İzleme ve Analiz - Stok Yönetimi</title>
    
    <!-- Cache önleyici meta tag'ler -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Favicon tanımlamaları -->
    <link rel="icon" type="image/x-icon" href="/static/site-icon.ico">
    <link rel="shortcut icon" href="/static/site-icon.ico" type="image/x-icon">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 16px;
        }
        
        nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            margin-bottom: 16px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
        }
        nav a {
            color: #4a5568;
            margin-right: 20px;
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        nav a:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 14px 18px;
            margin-bottom: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-left h1 {
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .last-updated {
            color: #4a5568;
            font-size: 13px;
            margin-bottom: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary {
            background: #4a5568;
            color: white;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            background: #cbd5e0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .progress-info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: #48bb78;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Filtre durumu göstergesi */
        .filter-status {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .visible-count {
            color: #48bb78;
            font-weight: 700;
            font-size: 15px;
        }

        .total-count {
            color: #4a5568;
            font-weight: 500;
        }

        .filter-indicator {
            padding: 4px 10px;
            background: #e6fffa;
            border: 1px solid #38b2ac;
            color: #234e52;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: none;
        }

        .filter-indicator.active {
            display: inline-block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .clear-all-filters {
            padding: 6px 12px;
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: none;
        }

        .clear-all-filters.active {
            display: inline-block;
        }

        .clear-all-filters:hover {
            background: #feb2b2;
            transform: translateY(-1px);
        }

        .no-data-message {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 40px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
            margin-bottom: 24px;
        }

        .no-data-message h3 {
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .no-data-message p {
            color: #4a5568;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .table-wrapper {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
            table-layout: fixed;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th {
            background: #9f7aea;
            color: white;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 42px;
        }

        /* Filtre satırı için özel stil */
        thead tr.filter-row th {
            background: #f8fafc !important;
            color: #2d3748 !important;
            font-weight: normal;
            font-size: 12px;
            text-transform: none;
            letter-spacing: normal;
            height: 45px;
        }

        /* Filtre input stilleri */
        .filter-input {
            width: 100%;
            max-width: 120px;
            padding: 6px 10px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s ease;
            background: white;
            color: #2d3748;
            height: 30px;
            box-sizing: border-box;
        }

        .filter-input:focus {
            outline: none;
            border-color: #9f7aea;
            box-shadow: 0 0 0 3px rgba(159, 122, 234, 0.1);
        }

        .filter-input::placeholder {
            color: #a0aec0;
        }

        .clear-filter-btn {
            padding: 5px 10px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            transition: all 0.2s ease;
            background: #e53e3e;
            color: white;
            height: 30px;
            box-sizing: border-box;
        }

        .clear-filter-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
        }
        
        tbody tr {
            transition: all 0.2s ease;
            height: 70px;
        }
        
        tbody tr:hover {
            background: rgba(159, 122, 234, 0.04);
        }
        
        tbody tr:nth-child(even) {
            background: rgba(248, 250, 252, 0.6);
        }
        
        tbody tr:nth-child(even):hover {
            background: rgba(159, 122, 234, 0.06);
        }

        .seller-name {
            max-width: 200px;
            cursor: pointer;
            color: #2d3748;
            font-weight: 500;
            text-align: left;
            padding-left: 12px;
            width: 200px;
        }

        .seller-name:hover {
            color: #9f7aea;
            text-decoration: underline;
        }

        .location-cell {
            color: #4a5568;
            font-weight: 500;
            min-width: 100px;
            width: 100px;
        }

        .data-cell {
            cursor: pointer;
            color: #9f7aea;
            font-weight: 600;
            transition: color 0.2s ease;
            min-width: 80px;
        }

        .data-cell:hover {
            color: #805ad5;
            text-decoration: underline;
        }

        .score-cell {
            cursor: pointer;
            color: #38b2ac;
            font-weight: 600;
            transition: color 0.2s ease;
            min-width: 80px;
        }

        .score-cell:hover {
            color: #319795;
            text-decoration: underline;
        }

        .rating-cell {
            cursor: pointer;
            color: #f6ad55;
            font-weight: 600;
            transition: color 0.2s ease;
            min-width: 80px;
        }

        .rating-cell:hover {
            color: #ed8936;
            text-decoration: underline;
        }

        .date-cell {
            color: #718096;
            font-size: 11px;
            min-width: 120px;
        }

        .delete-btn {
            background: #e53e3e;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #c53030;
            transform: scale(1.1);
        }

        /* Modal/Popup stilleri */
        .modal {
            display: none;
            position: fixed;
            z-index: 20000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 24px;
            border-radius: 12px;
            width: 700px;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }

        .close-btn:hover {
            color: #e53e3e;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #9f7aea;
            box-shadow: 0 0 0 3px rgba(159, 122, 234, 0.1);
        }

        .form-group input.error {
            border-color: #e53e3e;
            background: #fef5f5;
        }

        .form-group input.success {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .validation-message {
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .validation-message.error {
            color: #e53e3e;
            display: block;
        }

        .validation-message.success {
            color: #48bb78;
            display: block;
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .btn-save {
            background: #9f7aea;
            color: white;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .settings-modal .modal-content {
            width: 400px;
        }

        /* Grafik modal stilleri */
        .chart-modal .modal-content {
            width: 900px;
            max-width: 95%;
            height: 600px;
            overflow: hidden;
            z-index: 20001;
        }

        .chart-container {
            height: 480px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .chart-loading {
            text-align: center;
            padding: 100px;
        }

        .chart-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #9f7aea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-no-data {
            text-align: center;
            padding: 100px;
            color: #718096;
        }

        .chart-info {
            padding: 8px 20px 16px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            margin: 0 -24px -24px -24px;
            border-radius: 0 0 12px 12px;
            font-size: 12px;
            color: #718096;
        }

        /* Alert mesajları */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 15000;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease-out;
        }

        .modal-open .alert {
            display: none !important;
        }
        
        .alert.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-actions {
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 16px;
            }
            
            table {
                min-width: 1200px;
            }

            .filter-status {
                flex-direction: column;
                text-align: center;
            }

            .chart-modal .modal-content {
                width: 98%;
                height: 500px;
                margin: 5% auto;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>

<div class="container">
    <nav>
        <a href="{{ url_for('index') }}">Stok Güncelleme</a>
        <a href="{{ url_for('match') }}">Eşleştirme</a>
        <a href="{{ url_for('competitor.competitors') }}">🎯 Rakip Takip</a>
        <a href="{{ url_for('product.products') }}">📊 Ürün İzleme</a>
        <a href="{{ url_for('seller.sellers') }}">🏪 Satıcı İzleme</a>
        {% if session.role == 'admin' %}
        <a href="{{ url_for('users') }}">Kullanıcı Yönetimi</a>
        {% endif %}
        <a href="{{ url_for('profile') }}">Profil</a>
        <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
            <span style="color: #4a5568; font-size: 14px;">Hoş geldin, {{ session.username }}! 
                {% if session.role == 'admin' %}<span style="background: #9f7aea; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">ADMIN</span>{% endif %}
            </span>
            <a href="{{ url_for('logout') }}" style="background: #e53e3e; color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 13px; transition: all 0.2s ease;">Çıkış</a>
        </div>
    </nav>

    <div class="header">
        <div class="header-left">
            <h1>🏪 Satıcı İzleme ve Analiz</h1>
            <p class="last-updated">
                {% if last_update %}
                    Son güncelleme: {{ last_update[:19].replace('T', ' ') }}
                {% else %}
                    Henüz satıcı verisi yok
                {% endif %}
            </p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openAddSellerModal()">➕ Satıcı Ekle</button>
            <button class="btn btn-secondary" onclick="openSettingsModal()">⚙️ Ayarlar</button>
            <button class="btn btn-primary" id="manualUpdateBtn" onclick="startManualUpdate()">🔄 Güncelle</button>
        </div>
    </div>

    <!-- İlerleme durumu -->
    <div class="progress-info" id="progressInfo">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span id="progressText">Güncelleme başlatılıyor...</span>
            <span id="progressCounter">0/0</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div style="font-size: 12px; color: #718096; margin-top: 4px;" id="progressDetail"></div>
    </div>

    <!-- Tek satıcı ekleme ilerleme göstergesi -->
    <div class="progress-info" id="singleSellerProgress" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span id="singleProgressText">Satıcı kaydediliyor...</span>
            <span id="singleProgressStatus">●</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="singleProgressFill" style="width: 0%;"></div>
        </div>
        <div style="font-size: 12px; color: #718096; margin-top: 4px;" id="singleProgressDetail">
            Yeni satıcı sisteme ekleniyor...
        </div>
    </div>

    {% if not sellers %}
    <div class="no-data-message">
        <h3>🏪 Henüz satıcı eklenmedi</h3>
        <p>İzlemek istediğiniz Trendyol satıcılarını eklemek için "Satıcı Ekle" butonuna tıklayın.</p>
        <button class="btn btn-primary" onclick="openAddSellerModal()">➕ İlk Satıcıyı Ekle</button>
    </div>
    {% else %}

    <!-- Filtre durumu göstergesi -->
    <div class="filter-status">
        <div class="filter-info">
            <span class="visible-count" id="visibleCount">{{ sellers|length }}</span>
            <span>/</span>
            <span class="total-count" id="totalCount">{{ sellers|length }} satıcı gösteriliyor</span>
            <span class="filter-indicator" id="filterIndicator">🔍 Filtre aktif</span>
        </div>
        <button class="clear-all-filters" id="clearAllFilters">✕ Filtreleri Temizle</button>
    </div>

    <div class="table-wrapper">
        <table id="sellersTable">
            <thead>
                <tr>
                    <th style="width: 200px;">Satıcı Adı</th>
                    <th style="width: 100px;">Konum</th>
                    <th style="width: 80px;">Mağaza Yaşı</th>
                    <th style="width: 90px;">💎 Satıcı Puanı</th>
                    <th style="width: 100px;">👥 Takipçi Sayısı</th>
                    <th style="width: 90px;">📦 Ürün Sayısı</th>
                    <th style="width: 90px;">⭐ Genel Rating</th>
                    <th style="width: 110px;">📊 Toplam Değerlendirme</th>
                    <th style="width: 100px;">💬 Toplam Yorum</th>
                    <th style="width: 130px;">Son Güncelleme</th>
                    <th style="width: 60px;">İşlemler</th>
                </tr>
                <!-- Filtre satırı -->
                <tr class="filter-row">
                    <th>
                        <input type="text" id="nameFilter" class="filter-input" placeholder="Satıcı adında ara..." />
                    </th>
                    <th>
                        <input type="text" id="locationFilter" class="filter-input" placeholder="Konum ara..." />
                    </th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th>
                        <button class="clear-filter-btn" id="clearFilterBtn">Temizle</button>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for seller in sellers %}
                <tr data-link-id="{{ seller.link_id }}">
                    <td class="seller-name" onclick="openSellerUrl('{{ seller.all_products_url }}')">
                        {{ seller.seller_name[:25] }}{% if seller.seller_name|length > 25 %}...{% endif %}
                    </td>
                    <td class="location-cell">{{ seller.location }}</td>
                    <td class="data-cell">
                        {% if seller.store_age and seller.store_age > 0 %}
                            {{ seller.store_age }} Yıl
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="score-cell" onclick="openChartModal({{ seller.link_id }}, 'seller_score')">
                        {% if seller.seller_score and seller.seller_score > 0 %}
                            {{ "%.1f"|format(seller.seller_score) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="data-cell" onclick="openChartModal({{ seller.link_id }}, 'follower_count')">
                        {% if seller.follower_count and seller.follower_count > 0 %}
                            {{ seller.follower_count|format_follower_count }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="data-cell" onclick="openChartModal({{ seller.link_id }}, 'product_count')">
                        {% if seller.product_count and seller.product_count > 0 %}
                            {{ seller.product_count }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="rating-cell" onclick="openChartModal({{ seller.link_id }}, 'overall_rating')">
                        {% if seller.overall_rating and seller.overall_rating > 0 %}
                            {{ "%.1f"|format(seller.overall_rating) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="data-cell" onclick="openChartModal({{ seller.link_id }}, 'total_reviews')">
                        {% if seller.total_reviews and seller.total_reviews > 0 %}
                            {{ seller.total_reviews }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="data-cell" onclick="openChartModal({{ seller.link_id }}, 'total_comments')">
                        {% if seller.total_comments and seller.total_comments > 0 %}
                            {{ seller.total_comments }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="date-cell">{{ seller.last_update }}</td>
                    <td>
                        <button class="delete-btn" onclick="confirmDeleteSeller({{ seller.link_id }})" title="Satıcıyı Sil">✕</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- Satıcı Ekleme Modal -->
<div id="addSellerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Yeni Satıcı Ekle</h3>
            <button class="close-btn" onclick="closeAddSellerModal()">&times;</button>
        </div>
        
        <div class="form-group">
            <label for="allProductsUrl">Tüm Ürünler Sayfası Linki *</label>
            <input type="url" id="allProductsUrl" placeholder="https://www.trendyol.com/sr?sid=..." required />
            <div class="validation-message" id="allProductsValidation"></div>
            <small style="color: #718096; font-size: 12px; margin-top: 4px; display: block;">
                Satıcının tüm ürünlerini gösteren sayfa linki (/sr veya /butik içermeli)
            </small>
        </div>
        
        <div class="form-group">
            <label for="sellerProfileUrl">Satıcı Profili Linki *</label>
            <input type="url" id="sellerProfileUrl" placeholder="https://www.trendyol.com/satici-profili/..." required />
            <div class="validation-message" id="profileValidation"></div>
            <small style="color: #718096; font-size: 12px; margin-top: 4px; display: block;">
                Satıcının profil sayfası linki (satici-profili içermeli)
            </small>
        </div>
        
        <div class="modal-actions">
            <div></div>
            <div>
                <button class="btn btn-cancel" onclick="closeAddSellerModal()">İptal</button>
                <button class="btn btn-save" onclick="saveSeller()" id="saveSellerBtn">Kaydet ve Veri Çek</button>
            </div>
        </div>
    </div>
</div>

<!-- Ayarlar Modal -->
<div id="settingsModal" class="modal settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Satıcı İzleme Ayarları</h3>
            <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
        </div>
        
        <div class="form-group">
            <label for="scheduleTime">Otomatik Güncelleme Saati (HH:MM)</label>
            <input type="time" id="scheduleTime" />
            <small style="color: #718096; font-size: 12px; margin-top: 4px; display: block;">
                Türkiye saatiyle günlük otomatik veri çekme saati (Varsayılan: 12:00)
            </small>
        </div>
        
        <div class="modal-actions">
            <div></div>
            <div>
                <button class="btn btn-cancel" onclick="closeSettingsModal()">İptal</button>
                <button class="btn btn-save" onclick="saveSettings()">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<!-- Silme Onay Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Satıcıyı Sil</h3>
            <button class="close-btn" onclick="closeDeleteConfirmModal()">&times;</button>
        </div>
        
        <div style="padding: 20px 0; text-align: center;">
            <div style="font-size: 48px; color: #e53e3e; margin-bottom: 16px;">⚠️</div>
            <p style="font-size: 16px; color: #2d3748; margin-bottom: 8px;">Bu satıcıyı silmek istediğinize emin misiniz?</p>
            <p style="font-size: 14px; color: #718096;">Bu işlem geri alınamaz ve tüm geçmiş veriler silinir.</p>
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeDeleteConfirmModal()">Hayır, İptal Et</button>
            <button class="btn btn-danger" onclick="executeDeleteSeller()">Evet, Sil</button>
        </div>
    </div>
</div>

<!-- Grafik Modal -->
<div id="chartModal" class="modal chart-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="chartModalTitle">📈 Veri Geçmişi</h3>
            <button class="close-btn" onclick="closeChartModal()">&times;</button>
        </div>
        
        <div class="chart-container">
            <!-- Yükleniyor göstergesi -->
            <div id="chartLoading" class="chart-loading">
                <div style="font-size: 18px; color: #4a5568; margin-bottom: 20px;">📊 Grafik hazırlanıyor...</div>
                <div class="spinner"></div>
            </div>
            
            <!-- Grafik canvas -->
            <canvas id="dataChart" style="display: none; max-height: 380px; width: 100%;"></canvas>
            
            <!-- Veri yoksa mesaj -->
            <div id="chartNoData" class="chart-no-data" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 20px;">📉</div>
                <h4>Bu veri için henüz geçmiş yok</h4>
                <p>Veriler birikmeye başladığında grafik burada görünecek.</p>
            </div>
        </div>
        
        <!-- Grafik bilgileri -->
        <div class="chart-info">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                <span id="chartInfo">Son 30 günlük veri trendi</span>
                <span id="chartStats"></span>
            </div>
        </div>
    </div>
</div>

<script>
// Global değişkenler
let updateStatusInterval = null;
let currentChart = null;
let currentDeleteId = null;
let singleSellerProgressInterval = null;
let currentSingleSellerId = null;
let isModalOpen = false;

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    // Her 5 saniyede bir güncelleme durumunu kontrol et
    updateStatusInterval = setInterval(checkUpdateStatus, 5000);

    // Filtreleme işlemlerini başlat
    initializeFiltering();  

    // Admin olmayan kullanıcılar için buton ipucu
    const userRole = '{{ session.role }}';
    const updateBtn = document.getElementById('manualUpdateBtn');
    if (userRole !== 'admin' && updateBtn) {
        updateBtn.title = 'Sadece Admin Yetkili Kullanıcılar Kullanabilir';
        updateBtn.style.opacity = '0.7';
    }

    // URL validasyonu için event listener'lar
    setupUrlValidation();
});

// Filtreleme sistemini başlat
function initializeFiltering() {
    const nameFilter = document.getElementById('nameFilter');
    const locationFilter = document.getElementById('locationFilter');
    const clearFilterBtn = document.getElementById('clearFilterBtn');
    const clearAllBtn = document.getElementById('clearAllFilters');

    // Filtre event listener'ları
    if (nameFilter) {
        nameFilter.addEventListener('input', filterTable);
    }
    if (locationFilter) {
        locationFilter.addEventListener('input', filterTable);
    }

    // Filtre temizleme butonları
    if (clearFilterBtn) {
        clearFilterBtn.addEventListener('click', clearAllFilters);
    }
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllFilters);
    }

    // İlk sayaç güncellemesi
    updateFilterCount();
}

// Tabloyu filtrele
function filterTable() {
    const nameFilter = document.getElementById('nameFilter');
    const locationFilter = document.getElementById('locationFilter');
    const nameVal = nameFilter.value.trim().toLowerCase();
    const locationVal = locationFilter.value.trim().toLowerCase();
    const tableBody = document.querySelector('#sellersTable tbody');

    if (!tableBody) return;

    for (const row of tableBody.rows) {
        const nameCell = row.querySelector('.seller-name');
        const locationCell = row.querySelector('.location-cell');
        
        if (!nameCell || !locationCell) continue;

        const name = nameCell.innerText.toLowerCase();
        const location = locationCell.innerText.toLowerCase();
        
        // Filtreleme: Her iki kriterin de eşleşmesi
        const nameMatch = name.includes(nameVal);
        const locationMatch = location.includes(locationVal);

        if (nameMatch && locationMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }

    // Filtre sayacını güncelle
    updateFilterCount();
}

// Filtre sayacını güncelle
function updateFilterCount() {
    const totalRows = document.querySelectorAll('#sellersTable tbody tr').length;
    const visibleRows = document.querySelectorAll('#sellersTable tbody tr').length - 
                       document.querySelectorAll('#sellersTable tbody tr[style*="display: none"]').length;
    
    const visibleCountEl = document.getElementById('visibleCount');
    const totalCountEl = document.getElementById('totalCount');
    const filterIndicator = document.getElementById('filterIndicator');
    const clearAllBtn = document.getElementById('clearAllFilters');
    
    if (!visibleCountEl || !totalCountEl) return;

    // Sayaçları güncelle
    visibleCountEl.textContent = visibleRows;
    totalCountEl.textContent = `${totalRows} satıcı`;
    
    // Filtre durumunu kontrol et
    const nameFilter = document.getElementById('nameFilter');
    const locationFilter = document.getElementById('locationFilter');
    const hasActiveFilter = visibleRows < totalRows || 
                           (nameFilter && nameFilter.value.trim() !== '') ||
                           (locationFilter && locationFilter.value.trim() !== '');
    
    if (hasActiveFilter) {
        if (filterIndicator) filterIndicator.classList.add('active');
        if (clearAllBtn) clearAllBtn.classList.add('active');
        totalCountEl.textContent = `${totalRows} satıcıdan ${visibleRows} tanesi gösteriliyor`;
    } else {
        if (filterIndicator) filterIndicator.classList.remove('active');
        if (clearAllBtn) clearAllBtn.classList.remove('active');
        totalCountEl.textContent = `${totalRows} satıcı gösteriliyor`;
    }
}

// Tüm filtreleri temizle
function clearAllFilters() {
    const nameFilter = document.getElementById('nameFilter');
    const locationFilter = document.getElementById('locationFilter');
    
    if (nameFilter) nameFilter.value = '';
    if (locationFilter) locationFilter.value = '';
    
    // Tabloyu yeniden filtrele
    filterTable();
}

// Modal durum yönetimi
function setModalState(isOpen) {
    console.log('🔍 DEBUG: setModalState() çağrıldı - isOpen:', isOpen, '- Stack:', new Error().stack);
    isModalOpen = isOpen;
    
    if (isOpen) {
        document.body.classList.add('modal-open');
    } else {
        document.body.classList.remove('modal-open');
    }
}

// Alert gösterme fonksiyonu
function showAlert(message, type = 'success') {
    const chartModal = document.getElementById('chartModal');
    if (isModalOpen && chartModal && chartModal.style.display === 'block') {
        console.log('📢 Alert blocked (chart modal open):', message, type);
        return;
    }
    
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alert = document.createElement('div');
    alert.className = `alert ${type}`;
    alert.textContent = message;
    document.body.appendChild(alert);
    
    const autoRemoveTime = type === 'error' ? 6000 : 3000;
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.style.animation = 'slideOut 0.3s ease-in forwards';
            setTimeout(() => alert.remove(), 300);
        }
    }, autoRemoveTime);
}

// URL validasyonu kurulumu
function setupUrlValidation() {
    const allProductsInput = document.getElementById('allProductsUrl');
    const profileInput = document.getElementById('sellerProfileUrl');
    
    if (allProductsInput) {
        allProductsInput.addEventListener('input', debounce(validateUrls, 500));
        allProductsInput.addEventListener('blur', validateUrls);
    }
    
    if (profileInput) {
        profileInput.addEventListener('input', debounce(validateUrls, 500));
        profileInput.addEventListener('blur', validateUrls);
    }
}

// Debounce fonksiyonu
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// URL'leri validate et
async function validateUrls() {
    const allProductsInput = document.getElementById('allProductsUrl');
    const profileInput = document.getElementById('sellerProfileUrl');
    const saveBtn = document.getElementById('saveSellerBtn');
    
    const allProductsUrl = allProductsInput.value.trim();
    const sellerProfileUrl = profileInput.value.trim();
    
    if (!allProductsUrl && !sellerProfileUrl) {
        resetValidationStates();
        return;
    }
    
    try {
        const response = await fetch('/sellers/validate-urls', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                all_products_url: allProductsUrl,
                seller_profile_url: sellerProfileUrl
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const validation = data.validation;
            
            // Tüm ürünler URL validasyonu
            updateValidationState(
                allProductsInput, 
                'allProductsValidation',
                validation.all_products_valid,
                validation.all_products_message || 'Geçerli tüm ürünler sayfası linki ✓'
            );
            
            // Profil URL validasyonu
            updateValidationState(
                profileInput,
                'profileValidation', 
                validation.profile_valid,
                validation.profile_message || 'Geçerli satıcı profil linki ✓'
            );
            
            // Kaydet butonunu aktif/pasif yap
            if (saveBtn) {
                saveBtn.disabled = !(validation.all_products_valid && validation.profile_valid && allProductsUrl && sellerProfileUrl);
            }
        }
        
    } catch (error) {
        console.error('URL validasyon hatası:', error);
    }
}

// Validasyon durumunu güncelle
function updateValidationState(input, messageId, isValid, message) {
    const messageEl = document.getElementById(messageId);
    
    if (!input || !messageEl) return;
    
    // Input stilini güncelle
    input.classList.remove('error', 'success');
    if (input.value.trim()) {
        input.classList.add(isValid ? 'success' : 'error');
    }
    
    // Mesajı güncelle
    messageEl.classList.remove('error', 'success');
    if (input.value.trim()) {
        messageEl.classList.add(isValid ? 'success' : 'error');
        messageEl.textContent = message;
    } else {
        messageEl.textContent = '';
    }
}

// Validasyon durumlarını sıfırla
function resetValidationStates() {
    const inputs = ['allProductsUrl', 'sellerProfileUrl'];
    const messages = ['allProductsValidation', 'profileValidation'];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.classList.remove('error', 'success');
        }
    });
    
    messages.forEach(messageId => {
        const messageEl = document.getElementById(messageId);
        if (messageEl) {
            messageEl.classList.remove('error', 'success');
            messageEl.textContent = '';
        }
    });
    
    const saveBtn = document.getElementById('saveSellerBtn');
    if (saveBtn) {
        saveBtn.disabled = false;
    }
}

// Satıcı ekleme modal açma
function openAddSellerModal() {
    document.getElementById('addSellerModal').style.display = 'block';
    document.getElementById('allProductsUrl').focus();
    setModalState(true);
}

// Satıcı ekleme modal kapatma
function closeAddSellerModal() {
    console.log('🔍 DEBUG: closeAddSellerModal() çağrıldı - Stack:', new Error().stack);
    setModalState(false);
    document.getElementById('addSellerModal').style.display = 'none';
    
    // Input'ları temizle
    document.getElementById('allProductsUrl').value = '';
    document.getElementById('sellerProfileUrl').value = '';
    
    // Validasyon durumlarını sıfırla
    resetValidationStates();
}

// Satıcı kaydetme
async function saveSeller() {
    const allProductsUrl = document.getElementById('allProductsUrl').value.trim();
    const sellerProfileUrl = document.getElementById('sellerProfileUrl').value.trim();
    
    // Validation
    if (!allProductsUrl) {
        updateValidationState(
            document.getElementById('allProductsUrl'),
            'allProductsValidation',
            false,
            'Tüm ürünler sayfası linki boş olamaz!'
        );
        return;
    }
    
    if (!sellerProfileUrl) {
        updateValidationState(
            document.getElementById('sellerProfileUrl'),
            'profileValidation',
            false,
            'Satıcı profili linki boş olamaz!'
        );
        return;
    }
    
    // İlerleme göstergesini başlat
    showSingleSellerProgress();
    updateSingleSellerProgress(25, "Satıcı sisteme kaydediliyor...", "Kaydediliyor...");
    
    try {
        const response = await fetch('/sellers/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            },
            body: JSON.stringify({
                all_products_url: allProductsUrl,
                seller_profile_url: sellerProfileUrl
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentSingleSellerId = data.seller_link_id;
            
            updateSingleSellerProgress(50, "Satıcı kaydedildi! Veri çekiliyor...", "Scraping başladı...");
            closeAddSellerModal();
            
            // Scraping tamamlanana kadar izle
            startSingleSellerMonitoring();
            
        } else {
            hideSingleSellerProgress();
            showAlert('Hata: ' + data.error, 'error');
        }
        
    } catch (error) {
        hideSingleSellerProgress();
        showAlert('Ağ hatası: ' + error.message, 'error');
    }
}

// Ayarlar modal açma
async function openSettingsModal() {
    await loadSettings();
    document.getElementById('settingsModal').style.display = 'block';
    setModalState(true);
}

// Ayarlar modal kapatma
function closeSettingsModal() {
    setModalState(false);
    document.getElementById('settingsModal').style.display = 'none';
}

// Ayarları yükle
async function loadSettings() {
    try {
        const response = await fetch('/sellers/settings');
        const data = await response.json();
        
        if (data.success) {
            const scheduleTime = data.settings.schedule_time || '12:00';
            document.getElementById('scheduleTime').value = scheduleTime;
        }
        
    } catch (error) {
        console.error('Ayar yükleme hatası:', error);
    }
}

// Ayarları kaydet
async function saveSettings() {
    const scheduleTime = document.getElementById('scheduleTime').value;
    
    if (!scheduleTime) {
        showAlert('Lütfen bir saat seçin!', 'error');
        return;
    }
    
    try {
        const response = await fetch('/sellers/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ schedule_time: scheduleTime })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            closeSettingsModal();
        } else {
            showAlert('Hata: ' + data.error, 'error');
        }
        
    } catch (error) {
        showAlert('Ağ hatası: ' + error.message, 'error');
    }
}

// Manuel güncelleme başlat
async function startManualUpdate() {
    const userRole = '{{ session.role }}';
    if (userRole !== 'admin') {
        showAlert('❌ Sadece Admin Yetkili Kullanıcılar Bu Özelliği Kullanabilir', 'error');
        return;
    }

    const btn = document.getElementById('manualUpdateBtn');
    
    try {
        btn.disabled = true;
        btn.textContent = 'Başlatılıyor...';
        
        const response = await fetch('/sellers/update/manual', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            showProgressInfo();
        } else {
            showAlert('Hata: ' + data.error, 'error');
            btn.disabled = false;
            btn.textContent = '🔄 Güncelle';
        }
        
    } catch (error) {
        showAlert('Ağ hatası: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = '🔄 Güncelle';
    }
}

// İlerleme bilgisini göster/gizle
function showProgressInfo() {
    document.getElementById('progressInfo').style.display = 'block';
}

function hideProgressInfo() {
    document.getElementById('progressInfo').style.display = 'none';
    
    const btn = document.getElementById('manualUpdateBtn');
    btn.disabled = false;
    btn.textContent = '🔄 Güncelle';
}

// Güncelleme durumunu kontrol et
async function checkUpdateStatus() {
    try {
        const response = await fetch('/sellers/update/status');
        const data = await response.json();
        
        if (data.success) {
            const status = data.status;
            
            if (status.is_running) {
                showProgressInfo();
                
                const progress = status.total_items > 0 ? (status.current_progress / status.total_items) * 100 : 0;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressCounter').textContent = `${status.current_progress}/${status.total_items}`;
                document.getElementById('progressText').textContent = 'Satıcı verileri güncelleniyor...';
                document.getElementById('progressDetail').textContent = status.current_item || '';
                
            } else {
                hideProgressInfo();
                
                if (status.current_progress > 0) {
                    // Herhangi bir modal açıksa sayfa yenileme
                    if (!isModalOpen) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                }
                
                // Scraping çalışmıyorsa interval'ı durdur
                if (updateStatusInterval) {
                    clearInterval(updateStatusInterval);
                    updateStatusInterval = null;
                    console.log('🔍 DEBUG: Update status interval durduruldu - scraping bitti');
                }
            }
        }
        
    } catch (error) {
        // Silent error
    }
}

// Satıcı URL'ini aç
function openSellerUrl(url) {
    window.open(url, '_blank');
}

// Silme onayı modal
function confirmDeleteSeller(sellerLinkId) {
    currentDeleteId = sellerLinkId;
    document.getElementById('deleteConfirmModal').style.display = 'block';
    setModalState(true);
}

function closeDeleteConfirmModal() {
    setModalState(false);
    document.getElementById('deleteConfirmModal').style.display = 'none';
    currentDeleteId = null;
}

// Satıcı silme işlemi
async function executeDeleteSeller() {
    if (!currentDeleteId) return;
    
    try {
        const response = await fetch(`/sellers/delete/${currentDeleteId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            closeDeleteConfirmModal();
            
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('Hata: ' + data.error, 'error');
        }
        
    } catch (error) {
        showAlert('Ağ hatası: ' + error.message, 'error');
    }
}

// Grafik modal açma
async function openChartModal(sellerLinkId, dataType) {
    try {
        document.getElementById('chartModal').style.display = 'block';
        setModalState(true);
        document.getElementById('chartLoading').style.display = 'block';
        document.getElementById('dataChart').style.display = 'none';
        document.getElementById('chartNoData').style.display = 'none';
        
        // Veri tipine göre başlık belirle
        const dataTypeNames = {
            'seller_score': '💎 Satıcı Puanı',
            'product_count': '📦 Ürün Sayısı',
            'follower_count': '👥 Takipçi Sayısı', 
            'total_reviews': '📊 Toplam Değerlendirme',
            'total_comments': '💬 Toplam Yorum',
            'overall_rating': '⭐ Genel Rating'
        };
        
        document.getElementById('chartModalTitle').textContent = `📈 ${dataTypeNames[dataType]} Geçmişi`;
        
        // API'den veri çek
        const response = await fetch(`/sellers/history/${sellerLinkId}/${dataType}`);
        const data = await response.json();
        
        if (data.success) {
            if (data.history && data.history.length > 0) {
                await createDataChart(data);
                document.getElementById('chartLoading').style.display = 'none';
                document.getElementById('dataChart').style.display = 'block';
                updateChartStats(data);
            } else {
                document.getElementById('chartLoading').style.display = 'none';
                document.getElementById('chartNoData').style.display = 'block';
                document.getElementById('chartInfo').textContent = 'Bu veri için henüz geçmiş yok';
                document.getElementById('chartStats').textContent = '';
            }
        } else {
            throw new Error(data.error || 'Veri alınamadı');
        }
        
    } catch (error) {
        console.error('Grafik hatası:', error);
        showAlert('Grafik yüklenirken hata oluştu: ' + error.message, 'error');
        closeChartModal();
    }
}

// Chart.js ile grafik oluşturma
async function createDataChart(data) {
    const ctx = document.getElementById('dataChart').getContext('2d');
    
    if (currentChart) {
        currentChart.destroy();
    }
    
    const labels = [];
    const values = [];
    
    data.history.forEach(item => {
        const date = new Date(item.date);
        const displayDate = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
        labels.push(displayDate);
        values.push(item.value);
    });
    
    // Veri tipine göre renk belirleme
    let borderColor = '#9f7aea';
    let backgroundColor = 'rgba(159, 122, 234, 0.1)';
    
    if (data.data_type === 'seller_score') {
        borderColor = '#38b2ac';
        backgroundColor = 'rgba(56, 178, 172, 0.1)';
    } else if (data.data_type === 'overall_rating') {
        borderColor = '#f6ad55';
        backgroundColor = 'rgba(246, 173, 85, 0.1)';
    } else if (data.data_type === 'follower_count') {
        borderColor = '#4299e1';
        backgroundColor = 'rgba(66, 153, 225, 0.1)';
    }
    
    const config = {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: data.data_info.title,
                data: values,
                borderColor: borderColor,
                backgroundColor: backgroundColor,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: borderColor,
                pointBorderColor: borderColor,
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `${data.data_info.title} (Son ${data.total_days} Gün)`,
                    font: { size: 16, weight: 'bold' },
                    color: '#2d3748'
                },
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(45, 55, 72, 0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: borderColor,
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        title: function(context) {
                            return `📅 ${context[0].label}`;
                        },
                        label: function(context) {
                            return `${data.data_info.title}: ${context.raw} ${data.data_info.unit}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: { display: true, text: 'Tarih', font: { weight: 'bold' } },
                    grid: { color: 'rgba(160, 174, 192, 0.2)' }
                },
                y: {
                    display: true,
                    title: { display: true, text: `${data.data_info.title} (${data.data_info.unit})`, font: { weight: 'bold' } },
                    grid: { color: 'rgba(160, 174, 192, 0.2)' }
                }
            },
            interaction: { mode: 'nearest', axis: 'x', intersect: false }
        }
    };
    
    currentChart = new Chart(ctx, config);
}

// Grafik istatistiklerini güncelle
function updateChartStats(data) {
    const history = data.history;
    
    if (history.length === 0) {
        document.getElementById('chartStats').textContent = 'Veri yok';
        return;
    }
    
    const values = history.map(item => item.value).filter(value => value !== null);
    const minValue = Math.min(...values);
    const maxValue = Math.max(...values);
    const avgValue = values.reduce((sum, value) => sum + value, 0) / values.length;
    const latestValue = history[history.length - 1].value;
    
    const firstValue = history[0].value;
    const change = latestValue - firstValue;
    const changePercent = firstValue > 0 ? ((change / firstValue) * 100) : 0;
    
    const changeEmoji = change > 0 ? '📈' : change < 0 ? '📉' : '➡️';
    const changeColor = change > 0 ? '#48bb78' : change < 0 ? '#e53e3e' : '#718096';
    
    let formatFunction = (val) => val.toFixed(1);
    if (data.data_type === 'product_count' || data.data_type === 'follower_count' || 
        data.data_type === 'total_reviews' || data.data_type === 'total_comments') {
        formatFunction = (val) => Math.round(val);
    }
    
    document.getElementById('chartInfo').textContent = 
        `${history.length} günlük veri | Min: ${formatFunction(minValue)} | Max: ${formatFunction(maxValue)} | Ort: ${formatFunction(avgValue)}`;
    
    document.getElementById('chartStats').innerHTML = `
        <span style="color: ${changeColor};">
            ${changeEmoji} ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}% 
            (${change >= 0 ? '+' : ''}${formatFunction(change)})
        </span>
    `;
}

// Grafik modal kapatma
function closeChartModal() {
    setModalState(false);
    document.getElementById('chartModal').style.display = 'none';
    
    if (currentChart) {
        currentChart.destroy();
        currentChart = null;
    }
}

// Tek satıcı ilerleme fonksiyonları
function showSingleSellerProgress() {
    document.getElementById('singleSellerProgress').style.display = 'block';
}

function hideSingleSellerProgress() {
    document.getElementById('singleSellerProgress').style.display = 'none';
    if (singleSellerProgressInterval) {
        clearInterval(singleSellerProgressInterval);
        singleSellerProgressInterval = null;
    }
    currentSingleSellerId = null;
}

function updateSingleSellerProgress(percentage, text, status) {
    document.getElementById('singleProgressFill').style.width = percentage + '%';
    document.getElementById('singleProgressText').textContent = text;
    document.getElementById('singleProgressStatus').textContent = status;
}

function startSingleSellerMonitoring() {
    // 🛡️ Toplu güncelleme progress bar'ını gizle
    const progressInfo = document.getElementById('progressInfo');
    if (progressInfo) {
        progressInfo.style.display = 'none';
    }
    let progressPercentage = 50;
    let checkCount = 0;
    const maxChecks = 240; // 4 dakika maksimum
    
    singleSellerProgressInterval = setInterval(async () => {
        checkCount++;
        
        try {
            // Scraping durumunu da kontrol et
            const statusResponse = await fetch('/sellers/update/status');
            const statusData = await statusResponse.json();
            
            if (statusData.success && statusData.status) {
                const scrapingStatus = statusData.status;
                
                // Eğer scraping çalışıyorsa durum bilgisini göster
                if (scrapingStatus.is_running) {
                    progressPercentage = Math.min(95, 50 + (scrapingStatus.current_progress || 0) * 40);
                    updateSingleSellerProgress(
                        progressPercentage, 
                        scrapingStatus.current_item || "Satıcı verileri çekiliyor...", 
                        "Aktif"
                    );
                }
            }
            
            // Sayfa verilerini kontrol et
            const response = await fetch(`/sellers/refresh-data?t=${new Date().getTime()}`);
            const data = await response.json();
            
            if (data.success && data.sellers) {
                const newSeller = data.sellers.find(s => s.link_id === currentSingleSellerId);
                
                // Yeni verinin gelip gelmediğini kontrol et
                if (newSeller && 
                    newSeller.seller_name && 
                    newSeller.seller_name !== 'Satıcı adı yükleniyor...' &&
                    (newSeller.seller_score > 0 || newSeller.product_count > 0)) {
                    
                    updateSingleSellerProgress(100, "✅ Tamamlandı! Sayfa yenileniyor...", "Başarılı!");
                    
                    setTimeout(() => {
                        hideSingleSellerProgress();
                        showAlert('✅ Satıcı başarıyla eklendi ve veriler çekildi!', 'success');
                        
                        // Sayfayı yenile
                        setTimeout(() => {
                            window.location.reload(true);
                        }, 1500);
                    }, 2000);
                    
                    return; // Interval'ı durdur
                }
            }
            
            // İlerleme mesajları
            if (checkCount <= maxChecks) {
                const progressMessages = [
                    "Satıcı sayfaları analiz ediliyor...",
                    "Tüm ürünler sayfası çekiliyor...", 
                    "Profil sayfası çekiliyor...",
                    "Satıcı bilgileri parse ediliyor...",
                    "Takipçi sayısı hesaplanıyor...",
                    "Veriler kaydediliyor...",
                    "Son kontroller yapılıyor...",
                    "İşlem tamamlanıyor..."
                ];
                
                const messageIndex = Math.min(Math.floor(checkCount / 15), progressMessages.length - 1);
                
                // Scraping çalışmıyorsa genel mesaj göster
                if (!statusData.success || !statusData.status || !statusData.status.is_running) {
                    progressPercentage = Math.min(95, 50 + (checkCount * 1.5));
                    updateSingleSellerProgress(progressPercentage, progressMessages[messageIndex], "Çekiliyor...");
                }
            }
            
            // Maksimum süre aşıldıysa
            if (checkCount >= maxChecks) {
                updateSingleSellerProgress(95, "⚠️ İşlem uzun sürüyor, arka planda devam ediyor...", "Bekliyor");
                
                setTimeout(() => {
                    hideSingleSellerProgress();
                    showAlert('⚠️ Veri çekme işlemi arka planda devam ediyor. Sayfayı yenileyerek kontrol edebilirsiniz.', 'info');
                }, 3000);
            }
            
        } catch (error) {
            console.error('Single seller monitoring error:', error);
            
            // Hata durumunda da devam et, belki sonraki check'te çalışır
            if (checkCount >= maxChecks) {
                hideSingleSellerProgress();
                showAlert('⚠️ Veri takibinde sorun oluştu. Sayfayı yenileyin.', 'error');
            }
        }
        
    }, 2000); // 2 saniyede bir kontrol et
}

// Modal dışına tıklanırsa kapat
window.onclick = function(event) {
    const addSellerModal = document.getElementById('addSellerModal');
    const settingsModal = document.getElementById('settingsModal');
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const chartModal = document.getElementById('chartModal');
    
    if (event.target === addSellerModal) {
        closeAddSellerModal();
    }
    if (event.target === settingsModal) {
        closeSettingsModal();
    }
    if (event.target === deleteConfirmModal) {
        closeDeleteConfirmModal();
    }
    if (event.target === chartModal) {
        closeChartModal();
    }
}

// ESC tuşu ile modal kapatma
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && isModalOpen) {
        if (document.getElementById('chartModal').style.display === 'block') {
            closeChartModal();
        } else if (document.getElementById('addSellerModal').style.display === 'block') {
            closeAddSellerModal();
        } else if (document.getElementById('settingsModal').style.display === 'block') {
            closeSettingsModal();
        } else if (document.getElementById('deleteConfirmModal').style.display === 'block') {
            closeDeleteConfirmModal();
        }
    }
});

// Sayfa kapatılırken interval'ları temizle
window.addEventListener('beforeunload', function() {
    if (singleSellerProgressInterval) {
        clearInterval(singleSellerProgressInterval);
    }
    if (updateStatusInterval) {
        clearInterval(updateStatusInterval);
    }
});

console.log("✅ Satıcı izleme sayfası JavaScript yüklendi - Trendyol satıcı verisi takibi");

</script>

</body>
</html>