<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>√úr√ºn ƒ∞zleme ve Analiz - Stok Y√∂netimi</title>
    
    <!-- Cache √∂nleyici meta tag'ler -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Favicon tanƒ±mlamalarƒ± -->
    <link rel="icon" type="image/x-icon" href="/static/site-icon.ico">
    <link rel="shortcut icon" href="/static/site-icon.ico" type="image/x-icon">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px; /* Geni≈ületildi */
            margin: 0 auto;
            padding: 16px;
        }
        
        nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            margin-bottom: 16px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
        }
        nav a {
            color: #4a5568;
            margin-right: 20px;
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        nav a:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 14px 18px;
            margin-bottom: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-left h1 {
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .last-updated {
            color: #4a5568;
            font-size: 13px;
            margin-bottom: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary {
            background: #4a5568;
            color: white;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            background: #cbd5e0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .progress-info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: #48bb78;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Filtre durumu g√∂stergesi */
        .filter-status {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .visible-count {
            color: #48bb78;
            font-weight: 700;
            font-size: 15px;
        }

        .total-count {
            color: #4a5568;
            font-weight: 500;
        }

        .filter-indicator {
            padding: 4px 10px;
            background: #e6fffa;
            border: 1px solid #38b2ac;
            color: #234e52;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: none;
        }

        .filter-indicator.active {
            display: inline-block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .clear-all-filters {
            padding: 6px 12px;
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: none;
        }

        .clear-all-filters.active {
            display: inline-block;
        }

        .clear-all-filters:hover {
            background: #feb2b2;
            transform: translateY(-1px);
        }

        .no-data-message {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 40px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
            margin-bottom: 24px;
        }

        .no-data-message h3 {
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .no-data-message p {
            color: #4a5568;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .table-wrapper {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1500px; /* Daha da geni≈ületildi */
            table-layout: fixed; /* Sabit kolon geni≈ülikleri i√ßin */
        }
        
        th, td {
            padding: 10px 12px; /* Padding artƒ±rƒ±ldƒ± */
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th {
            background: #48bb78;
            color: white;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 42px;
        }

        /* Filtre satƒ±rƒ± i√ßin √∂zel stil */
        thead tr.filter-row th {
            background: #f8fafc !important;
            color: #2d3748 !important;
            font-weight: normal;
            font-size: 12px;
            text-transform: none;
            letter-spacing: normal;
            height: 45px;
        }

        /* Filtre input stilleri */
        .filter-input {
            width: 100%;
            max-width: 150px;
            padding: 6px 10px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s ease;
            background: white;
            color: #2d3748;
            height: 30px;
            box-sizing: border-box;
        }

        .filter-input:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
        }

        .filter-input::placeholder {
            color: #a0aec0;
        }

        .clear-filter-btn {
            padding: 5px 10px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            transition: all 0.2s ease;
            background: #e53e3e;
            color: white;
            height: 30px;
            box-sizing: border-box;
        }

        .clear-filter-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
        }
        
        tbody tr {
            transition: all 0.2s ease;
            height: 70px;
        }
        
        tbody tr:hover {
            background: rgba(72, 187, 120, 0.04);
        }
        
        tbody tr:nth-child(even) {
            background: rgba(248, 250, 252, 0.6);
        }
        
        tbody tr:nth-child(even):hover {
            background: rgba(72, 187, 120, 0.06);
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .product-image:hover {
            transform: scale(1.05);
        }

        .product-title {
            max-width: 250px; /* Geni≈ületildi */
            cursor: pointer;
            color: #2d3748;
            font-weight: 500;
            text-align: left;
            padding-left: 12px;
            width: 250px; /* Sabit geni≈ülik */
        }

        .seller-name {
            color: #4a5568;
            font-weight: 500;
            min-width: 120px;
            width: 120px; /* Sabit geni≈ülik */
        }

        .data-cell {
            cursor: pointer;
            color: #48bb78;
            font-weight: 600;
            transition: color 0.2s ease;
            min-width: 80px;
        }

        .data-cell:hover {
            color: #38a169;
            text-decoration: underline;
        }

        .rating-cell {
            color: #f6ad55;
            font-weight: 600;
        }

        /* YENƒ∞: Price cell √∂zel stil */
        .price-cell {
            cursor: pointer;
            color: #805ad5;
            font-weight: 600;
            transition: color 0.2s ease;
            min-width: 100px;
        }

        .price-cell:hover {
            color: #6b46c1;
            text-decoration: underline;
        }

        /* YENƒ∞: Seller rating cell √∂zel stil */
        .seller-rating-cell {
            cursor: pointer;
            color: #ed8936;
            font-weight: 600;
            transition: color 0.2s ease;
            min-width: 90px;
        }

        .seller-rating-cell:hover {
            color: #dd6b20;
            text-decoration: underline;
        }

        .date-cell {
            color: #718096;
            font-size: 11px;
            min-width: 120px;
        }

        .delete-btn {
            background: #e53e3e;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #c53030;
            transform: scale(1.1);
        }

        /* Modal/Popup stilleri */
        .modal {
            display: none;
            position: fixed;
            z-index: 20000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 24px;
            border-radius: 12px;
            width: 600px;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }

        .close-btn:hover {
            color: #e53e3e;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
        }

        .form-group input.error {
            border-color: #e53e3e;
            background: #fef5f5;
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .btn-save {
            background: #48bb78;
            color: white;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .settings-modal .modal-content {
            width: 400px;
        }

        /* Grafik modal stilleri */
        .chart-modal .modal-content {
            width: 900px;
            max-width: 95%;
            height: 600px;
            overflow: hidden;
            z-index: 20001; /* YENƒ∞: EN √úSTE √áIKARILDI */
        }

        .chart-container {
            height: 480px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .chart-loading {
            text-align: center;
            padding: 100px;
        }

        .chart-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-no-data {
            text-align: center;
            padding: 100px;
            color: #718096;
        }

        .chart-info {
            padding: 8px 20px 16px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            margin: 0 -24px -24px -24px;
            border-radius: 0 0 12px 12px;
            font-size: 12px;
            color: #718096;
        }

        /* Alert mesajlarƒ± */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 15000;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease-out;
        }

        /* YENƒ∞: Modal a√ßƒ±kken alert gizleme */
        .modal-open .alert {
            display: none !important;
        }
        
        .alert.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-actions {
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 16px;
            }
            
            table {
                min-width: 1000px;
            }

            .filter-status {
                flex-direction: column;
                text-align: center;
            }

            .chart-modal .modal-content {
                width: 98%;
                height: 500px;
                margin: 5% auto;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>

<div class="container">
    <nav>
        <a href="{{ url_for('index') }}">Stok G√ºncelleme</a>
        <a href="{{ url_for('match') }}">E≈üle≈ütirme</a>
        <a href="{{ url_for('competitor.competitors') }}">üéØ Rakip Takip</a>
        <a href="{{ url_for('product.products') }}">üìä √úr√ºn ƒ∞zleme</a>
        {% if session.role == 'admin' %}
        <a href="{{ url_for('users') }}">Kullanƒ±cƒ± Y√∂netimi</a>
        {% endif %}
        <a href="{{ url_for('profile') }}">Profil</a>
        <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
            <span style="color: #4a5568; font-size: 14px;">Ho≈ü geldin, {{ session.username }}! 
                {% if session.role == 'admin' %}<span style="background: #48bb78; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">ADMIN</span>{% endif %}
            </span>
            <a href="{{ url_for('logout') }}" style="background: #e53e3e; color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 13px; transition: all 0.2s ease;">√áƒ±kƒ±≈ü</a>
        </div>
    </nav>

    <div class="header">
        <div class="header-left">
            <h1>üìä √úr√ºn ƒ∞zleme ve Analiz</h1>
            <p class="last-updated">
                {% if last_update %}
                    Son g√ºncelleme: {{ last_update[:19].replace('T', ' ') }}
                {% else %}
                    Hen√ºz √ºr√ºn verisi yok
                {% endif %}
            </p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openAddProductModal()">‚ûï √úr√ºn Ekle</button>
            <button class="btn btn-secondary" onclick="openSettingsModal()">‚öôÔ∏è Ayarlar</button>
            <button class="btn btn-primary" id="manualUpdateBtn" onclick="startManualUpdate()">üîÑ G√ºncelle</button>
        </div>
    </div>

    <!-- ƒ∞lerleme durumu -->
    <div class="progress-info" id="progressInfo">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span id="progressText">G√ºncelleme ba≈ülatƒ±lƒ±yor...</span>
            <span id="progressCounter">0/0</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div style="font-size: 12px; color: #718096; margin-top: 4px;" id="progressDetail"></div>
    </div>

    <!-- Tek √ºr√ºn ekleme ilerleme g√∂stergesi -->
    <div class="progress-info" id="singleProductProgress" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span id="singleProgressText">√úr√ºn kaydediliyor...</span>
            <span id="singleProgressStatus">‚óè</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="singleProgressFill" style="width: 0%;"></div>
        </div>
        <div style="font-size: 12px; color: #718096; margin-top: 4px;" id="singleProgressDetail">
            Yeni √ºr√ºn sisteme ekleniyor...
        </div>
    </div>

    {% if not products %}
    <div class="no-data-message">
        <h3>üìä Hen√ºz √ºr√ºn eklenmedi</h3>
        <p>ƒ∞zlemek istediƒüiniz Trendyol √ºr√ºnlerini eklemek i√ßin "√úr√ºn Ekle" butonuna tƒ±klayƒ±n.</p>
        <button class="btn btn-primary" onclick="openAddProductModal()">‚ûï ƒ∞lk √úr√ºn√º Ekle</button>
    </div>
    {% else %}

    <!-- Filtre durumu g√∂stergesi -->
    <div class="filter-status">
        <div class="filter-info">
            <span class="visible-count" id="visibleCount">{{ products|length }}</span>
            <span>/</span>
            <span class="total-count" id="totalCount">{{ products|length }} √ºr√ºn g√∂steriliyor</span>
            <span class="filter-indicator" id="filterIndicator">üîç Filtre aktif</span>
        </div>
        <button class="clear-all-filters" id="clearAllFilters">‚úï Filtreleri Temizle</button>
    </div>

    <div class="table-wrapper">
        <table id="productsTable">
            <thead>
                <tr>
                    <th style="width: 80px;">Resim</th>
                    <th style="width: 250px;">√úr√ºn Adƒ±</th>
                    <th style="width: 120px;">Satƒ±cƒ±</th>
                    <th style="width: 110px;">üí∞ Fiyat</th>
                    <th style="width: 110px;">ƒ∞lk Yorum Tarihi</th>
                    <th style="width: 90px;">Yorum Sayƒ±sƒ±</th>
                    <th style="width: 70px;">Puanƒ±</th>
                    <th style="width: 80px;">Soru Adedi</th>
                    <th style="width: 90px;">‚≠ê Satƒ±cƒ± Puanƒ±</th>
                    <th style="width: 120px;">G√ºnl√ºk Tahmini Satƒ±≈ü</th>
                    <th style="width: 130px;">Son G√ºncelleme</th>
                    <th style="width: 60px;">ƒ∞≈ülemler</th>
                </tr>
                <!-- Filtre satƒ±rƒ± -->
                <tr class="filter-row">
                    <th>
                        <button class="clear-filter-btn" id="clearFilterBtn">Filtreleri Temizle</button>
                    </th>
                    <th>
                        <input type="text" id="titleFilter" class="filter-input" placeholder="√úr√ºn adƒ±nda ara..." />
                    </th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr data-link-id="{{ product.link_id }}">
                    <td>
                        {% if product.product_image_url %}
                            <img src="{{ product.product_image_url }}" alt="√úr√ºn Resmi" class="product-image" onclick="openProductUrl('{{ product.product_url }}')" />
                        {% else %}
                            <div style="width: 60px; height: 60px; background: #f7fafc; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #a0aec0; cursor: pointer;" onclick="openProductUrl('{{ product.product_url }}')">üì∑</div>
                        {% endif %}
                    </td>
                    <td class="product-title" onclick="openProductUrl('{{ product.product_url }}')">
                        {{ product.product_title[:35] }}{% if product.product_title|length > 35 %}...{% endif %}
                    </td>
                    <td class="seller-name">{{ product.seller_name }}</td>
                    <!-- YENƒ∞: Price kolonu - satƒ±cƒ± sonrasƒ±na ta≈üƒ±ndƒ± -->
                    <td class="price-cell" onclick="openChartModal({{ product.link_id }}, 'price')">
                        {% if product.price and product.price > 0 %}
                            {{ "%.2f"|format(product.price) }}‚Ç∫
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="date-cell">{{ product.first_comment_date }}</td>
                    <td class="data-cell" onclick="openChartModal({{ product.link_id }}, 'comment_count')">{{ product.comment_count }}</td>
                    <td class="data-cell rating-cell" onclick="openChartModal({{ product.link_id }}, 'rating')">{{ "%.1f"|format(product.rating) }}</td>
                    <td class="data-cell" onclick="openChartModal({{ product.link_id }}, 'question_count')">{{ product.question_count }}</td>
                    <!-- Seller Rating kolonu -->
                    <td class="seller-rating-cell" onclick="openChartModal({{ product.link_id }}, 'seller_rating')">
                        {% if product.seller_rating and product.seller_rating > 0 %}
                            {{ "%.1f"|format(product.seller_rating) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="data-cell" onclick="openChartModal({{ product.link_id }}, 'daily_estimated_sales')">{{ "%.1f"|format(product.daily_estimated_sales) }}</td>
                    <td class="date-cell">{{ product.last_update }}</td>
                    <td>
                        <button class="delete-btn" onclick="confirmDeleteProduct({{ product.link_id }})" title="√úr√ºn√º Sil">‚úï</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- √úr√ºn Ekleme Modal -->
<div id="addProductModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Yeni √úr√ºn Ekle</h3>
            <button class="close-btn" onclick="closeAddProductModal()">&times;</button>
        </div>
        
        <div class="form-group">
            <label for="productUrl">√úr√ºn Linki *</label>
            <input type="url" id="productUrl" placeholder="https://www.trendyol.com/..." required />
            <small style="color: #718096; font-size: 12px; margin-top: 4px; display: block;">
                Ge√ßerli bir Trendyol √ºr√ºn linki giriniz
            </small>
        </div>
        
        <div class="form-group">
            <label for="firstCommentDate">ƒ∞lk Yorum Tarihi *</label>
            <input type="text" id="firstCommentDate" placeholder="DD/MM/YYYY" required pattern="\d{2}/\d{2}/\d{4}" />
            <small style="color: #718096; font-size: 12px; margin-top: 4px; display: block;">
                G√ºn/Ay/Yƒ±l formatƒ±nda giriniz (√∂rn: 15/03/2024)
            </small>
        </div>
        
        <div class="modal-actions">
            <div></div>
            <div>
                <button class="btn btn-cancel" onclick="closeAddProductModal()">ƒ∞ptal</button>
                <button class="btn btn-save" onclick="saveProduct()">Kaydet ve Veri √áek</button>
            </div>
        </div>
    </div>
</div>

<!-- Ayarlar Modal -->
<div id="settingsModal" class="modal settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">√úr√ºn ƒ∞zleme Ayarlarƒ±</h3>
            <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
        </div>
        
        <div class="form-group">
            <label for="scheduleTime">Otomatik G√ºncelleme Saati (HH:MM)</label>
            <input type="time" id="scheduleTime" />
            <small style="color: #718096; font-size: 12px; margin-top: 4px; display: block;">
                T√ºrkiye saatiyle g√ºnl√ºk otomatik veri √ßekme saati
            </small>
        </div>
        
        <div class="modal-actions">
            <div></div>
            <div>
                <button class="btn btn-cancel" onclick="closeSettingsModal()">ƒ∞ptal</button>
                <button class="btn btn-save" onclick="saveSettings()">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<!-- Silme Onay Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">√úr√ºn√º Sil</h3>
            <button class="close-btn" onclick="closeDeleteConfirmModal()">&times;</button>
        </div>
        
        <div style="padding: 20px 0; text-align: center;">
            <div style="font-size: 48px; color: #e53e3e; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <p style="font-size: 16px; color: #2d3748; margin-bottom: 8px;">Bu √ºr√ºn√º silmek istediƒüinize emin misiniz?</p>
            <p style="font-size: 14px; color: #718096;">Bu i≈ülem geri alƒ±namaz ve t√ºm ge√ßmi≈ü veriler silinir.</p>
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeDeleteConfirmModal()">Hayƒ±r, ƒ∞ptal Et</button>
            <button class="btn btn-danger" onclick="executeDeleteProduct()">Evet, Sil</button>
        </div>
    </div>
</div>

<!-- Grafik Modal -->
<div id="chartModal" class="modal chart-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="chartModalTitle">üìà Veri Ge√ßmi≈üi</h3>
            <button class="close-btn" onclick="closeChartModal()">&times;</button>
        </div>
        
        <div class="chart-container">
            <!-- Y√ºkleniyor g√∂stergesi -->
            <div id="chartLoading" class="chart-loading">
                <div style="font-size: 18px; color: #4a5568; margin-bottom: 20px;">üìä Grafik hazƒ±rlanƒ±yor...</div>
                <div class="spinner"></div>
            </div>
            
            <!-- Grafik canvas -->
            <canvas id="dataChart" style="display: none; max-height: 380px; width: 100%;"></canvas>
            
            <!-- Veri yoksa mesaj -->
            <div id="chartNoData" class="chart-no-data" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 20px;">üìâ</div>
                <h4>Bu veri i√ßin hen√ºz ge√ßmi≈ü yok</h4>
                <p>Veriler birikmeye ba≈üladƒ±ƒüƒ±nda grafik burada g√∂r√ºnecek.</p>
            </div>
        </div>
        
        <!-- Grafik bilgileri -->
        <div class="chart-info">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                <span id="chartInfo">Son 30 g√ºnl√ºk veri trendi</span>
                <span id="chartStats"></span>
            </div>
        </div>
    </div>
</div>

<script>
// Global deƒüi≈ükenler
let updateStatusInterval = null;
let currentChart = null;
let currentDeleteId = null;
let singleProductProgressInterval = null;
let currentSingleProductId = null;
let isModalOpen = false; // YENƒ∞: Modal durum takibi

// CSS animasyonu ekle
const style = document.createElement('style');
style.textContent = `
@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
`;
document.head.appendChild(style);

// Sayfa y√ºklendiƒüinde
document.addEventListener('DOMContentLoaded', function() {
    // Her 5 saniyede bir g√ºncelleme durumunu kontrol et
    updateStatusInterval = setInterval(checkUpdateStatus, 5000);

    // Filtreleme i≈ülemlerini ba≈ülat
    initializeFiltering();  

    // Admin olmayan kullanƒ±cƒ±lar i√ßin buton ipucu
    const userRole = '{{ session.role }}';
    const updateBtn = document.getElementById('manualUpdateBtn');
    if (userRole !== 'admin' && updateBtn) {
        updateBtn.title = 'Sadece Admin Yetkili Kullanƒ±cƒ±lar Kullanabilir';
        updateBtn.style.opacity = '0.7';
    }
});

// Filtreleme sistemini ba≈ülat
function initializeFiltering() {
    const titleFilter = document.getElementById('titleFilter');
    const clearFilterBtn = document.getElementById('clearFilterBtn');
    const clearAllBtn = document.getElementById('clearAllFilters');

    // Ba≈ülƒ±k filtresi event listener
    if (titleFilter) {
        titleFilter.addEventListener('input', filterTable);
    }

    // Filtre temizleme butonlarƒ±
    if (clearFilterBtn) {
        clearFilterBtn.addEventListener('click', clearAllFilters);
    }
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllFilters);
    }

    // ƒ∞lk saya√ß g√ºncellemesi
    updateFilterCount();
}

// Tabloyu filtrele
function filterTable() {
    const titleFilter = document.getElementById('titleFilter');
    const titleVal = titleFilter.value.trim().toLowerCase();
    const tableBody = document.querySelector('#productsTable tbody');

    if (!tableBody) return;

    for (const row of tableBody.rows) {
        const titleCell = row.querySelector('.product-title');
        if (!titleCell) continue;

        const title = titleCell.innerText.toLowerCase();
        
        // Ba≈ülƒ±k filtreleme: Substring arama (her yerde ara)
        const titleMatch = title.includes(titleVal);

        if (titleMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }

    // Filtre sayacƒ±nƒ± g√ºncelle
    updateFilterCount();
}

// Filtre sayacƒ±nƒ± g√ºncelle
function updateFilterCount() {
    const totalRows = document.querySelectorAll('#productsTable tbody tr').length;
    const visibleRows = document.querySelectorAll('#productsTable tbody tr').length - 
                       document.querySelectorAll('#productsTable tbody tr[style*="display: none"]').length;
    
    const visibleCountEl = document.getElementById('visibleCount');
    const totalCountEl = document.getElementById('totalCount');
    const filterIndicator = document.getElementById('filterIndicator');
    const clearAllBtn = document.getElementById('clearAllFilters');
    
    if (!visibleCountEl || !totalCountEl) return;

    // Saya√ßlarƒ± g√ºncelle
    visibleCountEl.textContent = visibleRows;
    totalCountEl.textContent = `${totalRows} √ºr√ºn`;
    
    // Filtre durumunu kontrol et
    const titleFilter = document.getElementById('titleFilter');
    const hasActiveFilter = visibleRows < totalRows || (titleFilter && titleFilter.value.trim() !== '');
    
    if (hasActiveFilter) {
        if (filterIndicator) filterIndicator.classList.add('active');
        if (clearAllBtn) clearAllBtn.classList.add('active');
        totalCountEl.textContent = `${totalRows} √ºr√ºnden ${visibleRows} tanesi g√∂steriliyor`;
    } else {
        if (filterIndicator) filterIndicator.classList.remove('active');
        if (clearAllBtn) clearAllBtn.classList.remove('active');
        totalCountEl.textContent = `${totalRows} √ºr√ºn g√∂steriliyor`;
    }
}

// T√ºm filtreleri temizle
function clearAllFilters() {
    const titleFilter = document.getElementById('titleFilter');
    
    if (titleFilter) {
        titleFilter.value = '';
    }
    
    // Tabloyu yeniden filtrele
    filterTable();
}

// YENƒ∞: Modal durum y√∂netimi
function setModalState(isOpen) {
    isModalOpen = isOpen;
    
    // Body'ye class ekle/√ßƒ±kar
    if (isOpen) {
        document.body.classList.add('modal-open');
    } else {
        document.body.classList.remove('modal-open');
    }
}

// Alert g√∂sterme fonksiyonu - GELƒ∞≈ûTƒ∞Rƒ∞LDƒ∞
function showAlert(message, type = 'success') {
    // Modal a√ßƒ±kken alert g√∂sterme (√∂nemli hata mesajlarƒ± hari√ß)
    if (isModalOpen && type !== 'error') {
        console.log('üì¢ Alert blocked (modal open):', message, type);
        return;
    }
    
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alert = document.createElement('div');
    alert.className = `alert ${type}`;
    alert.textContent = message;
    document.body.appendChild(alert);
    
    // KISA S√úRE: 3 saniye (5 saniye yerine)
    const autoRemoveTime = type === 'error' ? 6000 : 3000;
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.style.animation = 'slideOut 0.3s ease-in forwards';
            setTimeout(() => alert.remove(), 300);
        }
    }, autoRemoveTime);
}

// √úr√ºn ekleme modal a√ßma
function openAddProductModal() {
    document.getElementById('addProductModal').style.display = 'block';
    document.getElementById('productUrl').focus();
    setModalState(true); // YENƒ∞
}

// √úr√ºn ekleme modal kapatma
function closeAddProductModal() {
    document.getElementById('addProductModal').style.display = 'none';
    
    // Input'larƒ± temizle
    document.getElementById('productUrl').value = '';
    document.getElementById('firstCommentDate').value = '';
    
    // Hata sƒ±nƒ±flarƒ±nƒ± temizle
    document.querySelectorAll('.form-group input').forEach(input => {
        input.classList.remove('error');
    });
}

// √úr√ºn kaydetme - AJAX ile dinamik g√ºncelleme
// saveProduct fonksiyonunu g√ºncelle - MEVCUT FONKSƒ∞YONU DEƒûI≈ûTIR:
async function saveProduct() {
    const productUrl = document.getElementById('productUrl').value.trim();
    const firstCommentDate = document.getElementById('firstCommentDate').value.trim();
    
    // Input'larƒ± temizle
    document.querySelectorAll('.form-group input').forEach(input => {
        input.classList.remove('error');
    });
    
    // Validation
    if (!productUrl) {
        document.getElementById('productUrl').classList.add('error');
        showAlert('√úr√ºn linki bo≈ü olamaz!', 'error');
        return;
    }
    
    if (!firstCommentDate) {
        document.getElementById('firstCommentDate').classList.add('error');
        showAlert('ƒ∞lk yorum tarihi bo≈ü olamaz!', 'error');
        return;
    }
    
    // Tarih formatƒ±nƒ± kontrol et
    const dateValidation = validateDateFormat(firstCommentDate);
    if (!dateValidation.valid) {
        document.getElementById('firstCommentDate').classList.add('error');
        showAlert(dateValidation.message, 'error');
        return;
    }
    
    // ƒ∞lerleme g√∂stergesini ba≈ülat
    showSingleProductProgress();
    updateSingleProductProgress(25, "√úr√ºn sisteme kaydediliyor...", "Kaydediliyor...");
    
    try {
        const response = await fetch('/products/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            },
            body: JSON.stringify({
                product_url: productUrl,
                first_comment_date: firstCommentDate
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentSingleProductId = data.product_link_id;
            
            updateSingleProductProgress(50, "√úr√ºn kaydedildi! Veri √ßekiliyor...", "Scraping ba≈üladƒ±...");
            closeAddProductModal();
            
            // Scraping tamamlanana kadar izle
            startSingleProductMonitoring();
            
        } else {
            hideSingleProductProgress();
            showAlert('Hata: ' + data.error, 'error');
            
            // Hatalƒ± alanƒ± i≈üaretle
            if (data.error.includes('link')) {
                document.getElementById('productUrl').classList.add('error');
            }
            if (data.error.includes('tarih')) {
                document.getElementById('firstCommentDate').classList.add('error');
            }
        }
        
    } catch (error) {
        hideSingleProductProgress();
        showAlert('Aƒü hatasƒ±: ' + error.message, 'error');
    }
}

// YENƒ∞: Tablo verilerini AJAX ile yenile
async function refreshTableData() {
    try {
        console.log('üîÑ Tablo verileri yenileniyor...');
        showAlert('üìä Veriler g√ºncelleniyor...', 'info');
        
        const timestamp = new Date().getTime();
        const response = await fetch(`/products/refresh-data?t=${timestamp}`, {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        });
        
        console.log('üì° API Response Status:', response.status);
        const data = await response.json();
        console.log('üì¶ API Response Data:', data);
        
        if (data.success && data.products) {
            console.log(`‚úÖ ${data.products.length} √ºr√ºn verisi alƒ±ndƒ±`);
            
            // Tabloyu yeniden olu≈ütur
            updateProductTable(data.products);
            
            // Filtre sayacƒ±nƒ± g√ºncelle
            updateFilterCount();
            
            showAlert('‚úÖ Veriler ba≈üarƒ±yla g√ºncellendi!', 'success');
        } else {
            throw new Error('Veri yenileme hatasƒ±: ' + (data.error || 'Bilinmeyen hata'));
        }
        
    } catch (error) {
        console.error('‚ùå Veri yenileme hatasƒ±:', error);
        showAlert('‚ö†Ô∏è Veriler g√ºncellenmedi, sayfa yenileniyor...', 'info');
        
        // AJAX ba≈üarƒ±sƒ±z olursa hard refresh
        setTimeout(() => {
            window.location.reload(true);
        }, 1500);
    }
}

// YENƒ∞: Tablo HTML'ini dinamik olarak g√ºncelle
function updateProductTable(products) {
    console.log('üîß Tablo g√ºncelleniyor, √ºr√ºn sayƒ±sƒ±:', products.length);
    
    const tbody = document.querySelector('#productsTable tbody');
    if (!tbody) {
        console.error('‚ùå Tablo tbody elementi bulunamadƒ±!');
        return;
    }
    
    // Mevcut satƒ±rlarƒ± temizle
    tbody.innerHTML = '';
    console.log('üßπ Mevcut satƒ±rlar temizlendi');
    
    // Yeni satƒ±rlarƒ± ekle
    products.forEach((product, index) => {
        const row = createProductRow(product);
        tbody.appendChild(row);
        console.log(`‚ûï Satƒ±r ${index + 1} eklendi: ${product.product_title.substring(0, 30)}...`);
    });
    
    console.log('‚úÖ Tablo g√ºncelleme tamamlandƒ±');
}

// YENƒ∞: √úr√ºn satƒ±rƒ± HTML olu≈ütur
function createProductRow(product) {
    const row = document.createElement('tr');
    row.setAttribute('data-link-id', product.link_id);
    
    row.innerHTML = `
        <td>
            ${product.product_image_url ? 
                `<img src="${product.product_image_url}" alt="√úr√ºn Resmi" class="product-image" onclick="openProductUrl('${product.product_url}')" />` :
                `<div style="width: 60px; height: 60px; background: #f7fafc; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #a0aec0; cursor: pointer;" onclick="openProductUrl('${product.product_url}')">üì∑</div>`
            }
        </td>
        <td class="product-title" onclick="openProductUrl('${product.product_url}')">
            ${product.product_title.length > 35 ? product.product_title.substring(0, 35) + '...' : product.product_title}
        </td>
        <td class="seller-name">${product.seller_name}</td>
        <td class="price-cell" onclick="openChartModal(${product.link_id}, 'price')">
            ${product.price && product.price > 0 ? parseFloat(product.price).toFixed(2) + '‚Ç∫' : '-'}
        </td>
        <td class="date-cell">${product.first_comment_date}</td>
        <td class="data-cell" onclick="openChartModal(${product.link_id}, 'comment_count')">${product.comment_count}</td>
        <td class="data-cell rating-cell" onclick="openChartModal(${product.link_id}, 'rating')">${parseFloat(product.rating).toFixed(1)}</td>
        <td class="data-cell" onclick="openChartModal(${product.link_id}, 'question_count')">${product.question_count}</td>
        <td class="seller-rating-cell" onclick="openChartModal(${product.link_id}, 'seller_rating')">
            ${product.seller_rating && product.seller_rating > 0 ? parseFloat(product.seller_rating).toFixed(1) : '-'}
        </td>
        <td class="data-cell" onclick="openChartModal(${product.link_id}, 'daily_estimated_sales')">${parseFloat(product.daily_estimated_sales).toFixed(1)}</td>
        <td class="date-cell">${product.last_update}</td>
        <td>
            <button class="delete-btn" onclick="confirmDeleteProduct(${product.link_id})" title="√úr√ºn√º Sil">‚úï</button>
        </td>
    `;
    
    return row;
}

// Ayarlar modal a√ßma
async function openSettingsModal() {
    await loadSettings();
    document.getElementById('settingsModal').style.display = 'block';
    setModalState(true); // YENƒ∞
}

// Ayarlar modal kapatma
function closeSettingsModal() {
    setModalState(false); // YENƒ∞
    document.getElementById('settingsModal').style.display = 'none';
}

// Ayarlarƒ± y√ºkle
async function loadSettings() {
    try {
        const response = await fetch('/products/settings');
        const data = await response.json();
        
        if (data.success) {
            const scheduleTime = data.settings.schedule_time || '10:00';
            document.getElementById('scheduleTime').value = scheduleTime;
        }
        
    } catch (error) {
        console.error('Ayar y√ºkleme hatasƒ±:', error);
    }
}

// Ayarlarƒ± kaydet
async function saveSettings() {
    const scheduleTime = document.getElementById('scheduleTime').value;
    
    if (!scheduleTime) {
        showAlert('L√ºtfen bir saat se√ßin!', 'error');
        return;
    }
    
    try {
        const response = await fetch('/products/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ schedule_time: scheduleTime })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            closeSettingsModal();
        } else {
            showAlert('Hata: ' + data.error, 'error');
        }
        
    } catch (error) {
        showAlert('Aƒü hatasƒ±: ' + error.message, 'error');
    }
}

// Manuel g√ºncelleme ba≈ülat
async function startManualUpdate() {
    // Admin kontrol√º
    const userRole = '{{ session.role }}';
    if (userRole !== 'admin') {
        showAlert('‚ùå Sadece Admin Yetkili Kullanƒ±cƒ±lar Bu √ñzelliƒüi Kullanabilir', 'error');
        return;
    }

    const btn = document.getElementById('manualUpdateBtn');
    
    try {
        btn.disabled = true;
        btn.textContent = 'Ba≈ülatƒ±lƒ±yor...';
        
        const response = await fetch('/products/update/manual', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            showProgressInfo();
        } else {
            showAlert('Hata: ' + data.error, 'error');
            btn.disabled = false;
            btn.textContent = 'üîÑ G√ºncelle';
        }
        
    } catch (error) {
        showAlert('Aƒü hatasƒ±: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'üîÑ G√ºncelle';
    }
}

// ƒ∞lerleme bilgisini g√∂ster
function showProgressInfo() {
    document.getElementById('progressInfo').style.display = 'block';
}

// ƒ∞lerleme bilgisini gizle
function hideProgressInfo() {
    document.getElementById('progressInfo').style.display = 'none';
    
    const btn = document.getElementById('manualUpdateBtn');
    btn.disabled = false;
    btn.textContent = 'üîÑ G√ºncelle';
}

// G√ºncelleme durumunu kontrol et
async function checkUpdateStatus() {
    try {
        const response = await fetch('/products/update/status');
        const data = await response.json();
        
        if (data.success) {
            const status = data.status;
            
            if (status.is_running) {
                showProgressInfo();
                
                // ƒ∞lerleme √ßubuƒüunu g√ºncelle
                const progress = status.total_items > 0 ? (status.current_progress / status.total_items) * 100 : 0;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressCounter').textContent = `${status.current_progress}/${status.total_items}`;
                document.getElementById('progressText').textContent = '√úr√ºn verileri g√ºncelleniyor...';
                document.getElementById('progressDetail').textContent = status.current_item || '';
                
            } else {
                hideProgressInfo();
                
                // Eƒüer az √∂nce i≈ülem bitmi≈ü ve sayfa hen√ºz yenilenmemi≈üse, sayfayƒ± yenile
                if (status.current_progress > 0) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }
        }
        
    } catch (error) {
        // Silent error - normal durum
    }
}

// √úr√ºn URL'ini yeni sekmede a√ß
function openProductUrl(url) {
    window.open(url, '_blank');
}

// Silme onayƒ± modal
function confirmDeleteProduct(productLinkId) {
    currentDeleteId = productLinkId;
    document.getElementById('deleteConfirmModal').style.display = 'block';
    setModalState(true); // YENƒ∞
}

// Silme onay modal kapatma
function closeDeleteConfirmModal() {
    setModalState(false); // YENƒ∞
    document.getElementById('deleteConfirmModal').style.display = 'none';
    currentDeleteId = null;
}

// √úr√ºn silme i≈ülemini ger√ßekle≈ütir
async function executeDeleteProduct() {
    if (!currentDeleteId) return;
    
    try {
        const response = await fetch(`/products/delete/${currentDeleteId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            closeDeleteConfirmModal();
            
            // Sayfayƒ± yenile
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('Hata: ' + data.error, 'error');
        }
        
    } catch (error) {
        showAlert('Aƒü hatasƒ±: ' + error.message, 'error');
    }
}

// Grafik modal a√ßma - YENƒ∞ ALANLAR EKLENDƒ∞
async function openChartModal(productLinkId, dataType) {
    try {
        // Modal'ƒ± g√∂ster ve loading state'i ba≈ülat
        document.getElementById('chartModal').style.display = 'block';
        setModalState(true); // YENƒ∞: Modal a√ßƒ±k olduƒüunu kaydet
        document.getElementById('chartLoading').style.display = 'block';
        document.getElementById('dataChart').style.display = 'none';
        document.getElementById('chartNoData').style.display = 'none';
        
        // Veri tipine g√∂re ba≈ülƒ±k belirle - YENƒ∞ ALANLAR EKLENDƒ∞
        const dataTypeNames = {
            'comment_count': 'Yorum Sayƒ±sƒ±',
            'rating': '√úr√ºn Puanƒ±', 
            'question_count': 'Soru Sayƒ±sƒ±',
            'daily_estimated_sales': 'G√ºnl√ºk Tahmini Satƒ±≈ü',
            'price': 'üí∞ Fiyat Trendi',              // YENƒ∞
            'seller_rating': '‚≠ê Satƒ±cƒ± Puanƒ±'       // YENƒ∞
        };
        
        document.getElementById('chartModalTitle').textContent = `üìà ${dataTypeNames[dataType]} Ge√ßmi≈üi`;
        
        // API'den veri √ßek
        const response = await fetch(`/products/history/${productLinkId}/${dataType}`);
        const data = await response.json();
        
        if (data.success) {
            if (data.history && data.history.length > 0) {
                // Grafik olu≈ütur
                await createDataChart(data);
                
                // Loading'i gizle, grafiƒüi g√∂ster
                document.getElementById('chartLoading').style.display = 'none';
                document.getElementById('dataChart').style.display = 'block';
                
                // ƒ∞statistikleri g√ºncelle
                updateChartStats(data);
            } else {
                // Veri yoksa mesaj g√∂ster
                document.getElementById('chartLoading').style.display = 'none';
                document.getElementById('chartNoData').style.display = 'block';
                
                // Bilgi g√ºncelle
                document.getElementById('chartInfo').textContent = 'Bu veri i√ßin hen√ºz ge√ßmi≈ü yok';
                document.getElementById('chartStats').textContent = '';
            }
        } else {
            throw new Error(data.error || 'Veri alƒ±namadƒ±');
        }
        
    } catch (error) {
        console.error('Grafik hatasƒ±:', error);
        showAlert('Grafik y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
        closeChartModal();
    }
}

// Chart.js ile grafik olu≈üturma - YENƒ∞ VERƒ∞ Tƒ∞PLERƒ∞ DESTEKLENDƒ∞
async function createDataChart(data) {
    const ctx = document.getElementById('dataChart').getContext('2d');
    
    // Mevcut grafiƒüi temizle
    if (currentChart) {
        currentChart.destroy();
    }
    
    // Veriyi hazƒ±rla
    const labels = [];
    const values = [];
    
    data.history.forEach(item => {
        const date = new Date(item.date);
        const displayDate = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
        labels.push(displayDate);
        values.push(item.value);
    });
    
    // Veri tipine g√∂re renk belirleme - YENƒ∞ RENKLER EKLENDƒ∞
    let borderColor = '#48bb78';
    let backgroundColor = 'rgba(72, 187, 120, 0.1)';
    
    if (data.data_type === 'price') {
        borderColor = '#805ad5';
        backgroundColor = 'rgba(128, 90, 213, 0.1)';
    } else if (data.data_type === 'seller_rating') {
        borderColor = '#ed8936';
        backgroundColor = 'rgba(237, 137, 54, 0.1)';
    } else if (data.data_type === 'rating') {
        borderColor = '#f6ad55';
        backgroundColor = 'rgba(246, 173, 85, 0.1)';
    }
    
    // Chart.js konfig√ºrasyonu
    const config = {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: data.data_info.title,
                data: values,
                borderColor: borderColor,
                backgroundColor: backgroundColor,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: borderColor,
                pointBorderColor: borderColor,
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `${data.data_info.title} (Son ${data.total_days} G√ºn)`,
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    color: '#2d3748'
                },
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(45, 55, 72, 0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: borderColor,
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        title: function(context) {
                            const date = context[0].label;
                            return `üìÖ ${date}`;
                        },
                        label: function(context) {
                            const value = context.raw;
                            return `${data.data_info.title}: ${value} ${data.data_info.unit}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Tarih',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(160, 174, 192, 0.2)'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: `${data.data_info.title} (${data.data_info.unit})`,
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(160, 174, 192, 0.2)'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    };
    
    // Grafiƒüi olu≈ütur
    currentChart = new Chart(ctx, config);
}

// Grafik istatistiklerini g√ºncelle
function updateChartStats(data) {
    const history = data.history;
    
    if (history.length === 0) {
        document.getElementById('chartStats').textContent = 'Veri yok';
        return;
    }
    
    // ƒ∞statistikleri hesapla
    const values = history.map(item => item.value).filter(value => value !== null);
    const minValue = Math.min(...values);
    const maxValue = Math.max(...values);
    const avgValue = values.reduce((sum, value) => sum + value, 0) / values.length;
    const latestValue = history[history.length - 1].value;
    
    // Deƒüi≈üim hesapla
    const firstValue = history[0].value;
    const change = latestValue - firstValue;
    const changePercent = firstValue > 0 ? ((change / firstValue) * 100) : 0;
    
    // Deƒüi≈üim y√∂n√º emojisi
    const changeEmoji = change > 0 ? 'üìà' : change < 0 ? 'üìâ' : '‚û°Ô∏è';
    const changeColor = change > 0 ? '#48bb78' : change < 0 ? '#e53e3e' : '#718096';
    
    // Sayƒ± formatƒ±nƒ± veri tipine g√∂re ayarla
    let formatFunction = (val) => val.toFixed(1);
    if (data.data_type === 'price') {
        formatFunction = (val) => val.toFixed(2) + '‚Ç∫';
    } else if (data.data_type === 'comment_count' || data.data_type === 'question_count') {
        formatFunction = (val) => Math.round(val);
    }
    
    document.getElementById('chartInfo').textContent = 
        `${history.length} g√ºnl√ºk veri | Min: ${formatFunction(minValue)} | Max: ${formatFunction(maxValue)} | Ort: ${formatFunction(avgValue)}`;
    
    document.getElementById('chartStats').innerHTML = `
        <span style="color: ${changeColor};">
            ${changeEmoji} ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}% 
            (${change >= 0 ? '+' : ''}${formatFunction(change)})
        </span>
    `;
}

// Grafik modal kapatma
function closeChartModal() {
    setModalState(false); // YENƒ∞
    document.getElementById('chartModal').style.display = 'none';
    
    // Grafiƒüi temizle
    if (currentChart) {
        currentChart.destroy();
        currentChart = null;
    }
}

// Modal dƒ±≈üƒ±na tƒ±klanƒ±rsa kapat
window.onclick = function(event) {
    const addProductModal = document.getElementById('addProductModal');
    const settingsModal = document.getElementById('settingsModal');
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const chartModal = document.getElementById('chartModal');
    
    if (event.target === addProductModal) {
        closeAddProductModal();
    }
    if (event.target === settingsModal) {
        closeSettingsModal();
    }
    if (event.target === deleteConfirmModal) {
        closeDeleteConfirmModal();
    }
    if (event.target === chartModal) {
        closeChartModal();
    }
}

// Tek √ºr√ºn ilerleme fonksiyonlarƒ±:
function showSingleProductProgress() {
    document.getElementById('singleProductProgress').style.display = 'block';
}

function hideSingleProductProgress() {
    document.getElementById('singleProductProgress').style.display = 'none';
    if (singleProductProgressInterval) {
        clearInterval(singleProductProgressInterval);
        singleProductProgressInterval = null;
    }
    currentSingleProductId = null;
}

function updateSingleProductProgress(percentage, text, status) {
    document.getElementById('singleProgressFill').style.width = percentage + '%';
    document.getElementById('singleProgressText').textContent = text;
    document.getElementById('singleProgressStatus').textContent = status;
}

function startSingleProductMonitoring() {
    let progressPercentage = 50;
    let checkCount = 0;
    const maxChecks = 300; // 5 dakika maksimum bekleme (ger√ßekte scraping 2-3 dakika s√ºrebiliyor)
    
    singleProductProgressInterval = setInterval(async () => {
        checkCount++;
        
        try {
            // Veritabanƒ±nda bu √ºr√ºn i√ßin veri var mƒ± kontrol et
            const response = await fetch(`/products/refresh-data?t=${new Date().getTime()}`);
            const data = await response.json();
            
            if (data.success && data.products) {
                // Yeni eklenen √ºr√ºn√º bul
                const newProduct = data.products.find(p => p.link_id === currentSingleProductId);
                
                if (newProduct && 
                    newProduct.product_title && 
                    newProduct.product_title !== 'Ba≈ülƒ±k y√ºkleniyor...' &&
                    newProduct.price && 
                    newProduct.rating &&
                    newProduct.product_image_url &&
                    newProduct.seller_name) {
                    // Scraping tamamlandƒ±!
                    updateSingleProductProgress(100, "‚úÖ Tamamlandƒ±! Sayfa yenileniyor...", "Ba≈üarƒ±lƒ±!");
                    
                    setTimeout(() => {
                        hideSingleProductProgress();
                        showAlert('‚úÖ √úr√ºn ba≈üarƒ±yla eklendi ve veriler √ßekildi!', 'success');
                        
                        // Sayfayƒ± yenile
                        setTimeout(() => {
                            window.location.reload(true);
                        }, 1500);
                    }, 2000);
                    
                } else {
                    // Hala devam ediyor, ilerleme artƒ±r
                    progressPercentage = Math.min(95, 50 + (checkCount * 2));
                    
                    const progressMessages = [
                        "√úr√ºn sayfasƒ± analiz ediliyor...",
                        "√úr√ºn bilgileri √ßekiliyor...",
                        "Resim URL'si bulunuyor...",
                        "Yorum ve puan bilgileri alƒ±nƒ±yor...",
                        "Satƒ±≈ü verileri hesaplanƒ±yor...",
                        "Veriler kaydediliyor...",
                        "Son kontroller yapƒ±lƒ±yor...",
                        "ƒ∞≈ülem tamamlanƒ±yor..."
                    ];
                    
                    const messageIndex = Math.min(Math.floor(checkCount / 8), progressMessages.length - 1);
                    updateSingleProductProgress(progressPercentage, progressMessages[messageIndex], "√áekiliyor...");
                }
            }
            
            // Maksimum bekleme s√ºresini a≈ütƒ±ysa
            if (checkCount >= maxChecks) {
                updateSingleProductProgress(95, "‚ö†Ô∏è ƒ∞≈ülem uzun s√ºr√ºyor, arka planda devam ediyor...", "Bekliyor");
                
                setTimeout(() => {
                    hideSingleProductProgress();
                    showAlert('‚ö†Ô∏è Veri √ßekme i≈ülemi arka planda devam ediyor. Sayfayƒ± yenileyerek kontrol edebilirsiniz.', 'info');
                }, 3000);
            }
            
        } catch (error) {
            console.error('Single product monitoring error:', error);
        }
        
    }, 1000); // Her saniye kontrol et
}

// Modal kapatma fonksiyonlarƒ±nƒ± g√ºncelle - MEVCUT FUNKTIONLARA EKLE:
function closeAddProductModal() {
    setModalState(false); // YENƒ∞ - BURAYA EKLE
    document.getElementById('addProductModal').style.display = 'none';
    
    // Input'larƒ± temizle
    document.getElementById('productUrl').value = '';
    document.getElementById('firstCommentDate').value = '';
    
    // Hata sƒ±nƒ±flarƒ±nƒ± temizle
    document.querySelectorAll('.form-group input').forEach(input => {
        input.classList.remove('error');
    });
    
    // NOT: ƒ∞lerleme √ßubuƒüunu kapatma - √ß√ºnk√º scraping devam ediyor
}

// Otomatik tarih formatƒ±
function formatDateInput(input) {
    // Sadece rakamlarƒ± al
    let value = input.value.replace(/\D/g, '');
    
    // Maksimum 8 rakam (DDMMYYYY)
    if (value.length > 8) {
        value = value.substring(0, 8);
    }
    
    // Otomatik formatla
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2);
    }
    if (value.length >= 5) {
        value = value.substring(0, 5) + '/' + value.substring(5);
    }
    
    input.value = value;
}


// Geli≈ümi≈ü tarih validasyonu
function validateDateFormat(dateString) {
    // DD/MM/YYYY formatƒ±nƒ± kontrol et
    const datePattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
    const match = dateString.match(datePattern);
    
    if (!match) {
        return { valid: false, message: 'Tarih formatƒ± DD/MM/YYYY olmalƒ±dƒ±r!' };
    }
    
    const day = parseInt(match[1]);
    const month = parseInt(match[2]);
    const year = parseInt(match[3]);
    
    // Temel tarih kontrol√º
    if (day < 1 || day > 31) {
        return { valid: false, message: 'G√ºn 1-31 arasƒ±nda olmalƒ±dƒ±r!' };
    }
    
    if (month < 1 || month > 12) {
        return { valid: false, message: 'Ay 1-12 arasƒ±nda olmalƒ±dƒ±r!' };
    }
    
    if (year < 2000 || year > new Date().getFullYear()) {
        return { valid: false, message: 'Yƒ±l 2000-' + new Date().getFullYear() + ' arasƒ±nda olmalƒ±dƒ±r!' };
    }
    
    return { valid: true };
}

// Sayfa y√ºklendiƒüinde tarih input'unu hazƒ±rla
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('firstCommentDate');
    
    if (dateInput) {
        // Kullanƒ±cƒ± yazarken otomatik formatla
        dateInput.addEventListener('input', function(e) {
            formatDateInput(e.target);
        });
        
        // Placeholder'ƒ± g√ºncelle
        dateInput.placeholder = '√ñrnek: 15012024 ‚Üí 15/01/2024';
        
        // Focus olduƒüunda ipucu g√∂ster
        dateInput.addEventListener('focus', function() {
            if (!this.value) {
                showAlert('üí° ƒ∞pucu: Sadece rakamlarƒ± yazƒ±n, "/" otomatik eklenecek (√∂rn: 15012024)', 'info');
            }
        });
    }
});

console.log("‚úÖ √úr√ºn izleme sayfasƒ± JavaScript y√ºklendi - Price ve Seller Rating desteƒüi eklendi");

// ESC tu≈üu ile modal kapatma
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && isModalOpen) {
        console.log('‚å®Ô∏è ESC tu≈üu ile modal kapatƒ±lƒ±yor...');
        
        // Hangi modal a√ßƒ±ksa onu kapat
        if (document.getElementById('chartModal').style.display === 'block') {
            closeChartModal();
        } else if (document.getElementById('addProductModal').style.display === 'block') {
            closeAddProductModal();
        } else if (document.getElementById('settingsModal').style.display === 'block') {
            closeSettingsModal();
        } else if (document.getElementById('deleteConfirmModal').style.display === 'block') {
            closeDeleteConfirmModal();
        }
    }
});

// Sayfa y√ºklendiƒüinde interval'larƒ± temizle - MEVCUT KODA EKLE:
window.addEventListener('beforeunload', function() {
    if (singleProductProgressInterval) {
        clearInterval(singleProductProgressInterval);
    }
});

</script>

</body>
</html>